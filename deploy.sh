#!/bin/bash
set -e

echo "ğŸš€ ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ 1C-Bitrix24 Integration..."

cd /root/morozov

if [ ! -f ".env" ]; then
    echo "âŒ Ğ¤Ğ°Ğ¹Ğ» .env Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!"
    exit 1
fi

echo "âœ… Ğ¤Ğ°Ğ¹Ğ» .env Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"

echo "ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²..."
docker-compose down 2>/dev/null || true

echo "ğŸ”¨ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°..."
docker-compose build

mkdir -p logs

echo "â–¶ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞº middleware..."
docker-compose up -d

sleep 5
if docker-compose ps | grep -q "Up"; then
    echo "âœ… Middleware ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!"
    echo "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:"
    docker-compose ps
    echo ""
    echo "ğŸŒ API: http://178.128.20.100:8000"
else
    echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°"
    docker-compose logs
    exit 1
fi

echo ""
echo "ğŸ‰ Ğ Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾!"
